name: Run JUnit Tests and Publish to Zephyr Squad

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

env:
  # Configure these for your project
  JAVA_VERSION: '17'
  TEST_CYCLE_NAME: 'Automated Build - ${{ github.run_number }}'

jobs:
  test-and-report:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: maven
        
    - name: Run JUnit tests with Maven
      run: mvn clean test
      continue-on-error: true
      
    - name: Generate JUnit XML report
      run: mvn surefire-report:report
      if: always()
      
    - name: Publish Test Results to GitHub
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: JUnit Test Results
        path: target/surefire-reports/*.xml
        reporter: java-junit
        fail-on-error: false
        
    - name: Upload to Zephyr Squad
      if: always()
      env:
        ZEPHYR_API_TOKEN: ${{ secrets.ZEPHYR_API_TOKEN }}
        JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
      run: |
        # Validate required secrets
        if [ -z "$ZEPHYR_API_TOKEN" ]; then
          echo "‚ùå ERROR: ZEPHYR_API_TOKEN secret is not set"
          echo "Please add your Zephyr Squad API token to GitHub Secrets"
          exit 1
        fi
        
        if [ -z "$JIRA_PROJECT_KEY" ]; then
          echo "‚ùå ERROR: JIRA_PROJECT_KEY secret is not set"
          echo "Please add your Jira project key to GitHub Secrets"
          exit 1
        fi
        
        # Validate token format (should start with eyJ for JWT)
        TOKEN_START=$(echo "$ZEPHYR_API_TOKEN" | cut -c1-3)
        TOKEN_LENGTH=${#ZEPHYR_API_TOKEN}
        
        echo "üîç Token validation:"
        echo "  - Length: $TOKEN_LENGTH characters"
        echo "  - Starts with: $TOKEN_START"
        
        if [ "$TOKEN_START" != "eyJ" ]; then
          echo "‚ö†Ô∏è  WARNING: Token doesn't start with 'eyJ' (expected for JWT tokens)"
          echo "The token might be incorrectly formatted"
        fi
        
        if [ $TOKEN_LENGTH -lt 100 ]; then
          echo "‚ùå ERROR: Token seems too short (${TOKEN_LENGTH} chars)"
          echo "A valid Zephyr API token should be several hundred characters long"
          exit 1
        fi
        
        # Check if test results exist
        if ! ls target/surefire-reports/TEST-*.xml 1> /dev/null 2>&1; then
          echo "‚ùå ERROR: No test results found in target/surefire-reports/"
          echo "Make sure Maven tests were executed successfully"
          exit 1
        fi
        
        # Count test files
        TEST_FILE_COUNT=$(ls -1 target/surefire-reports/TEST-*.xml 2>/dev/null | wc -l)
        echo "üìä Found $TEST_FILE_COUNT test result file(s)"
        
        # Option 1: Upload single combined file
        echo ""
        echo "üì¶ Combining test results..."
        find target/surefire-reports -name "TEST-*.xml" -exec cat {} \; > combined-results.xml
        
        # Verify combined file has content
        if [ ! -s combined-results.xml ]; then
          echo "‚ùå ERROR: Combined results file is empty"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < combined-results.xml)
        echo "  - Combined file size: $FILE_SIZE bytes"
        
        echo ""
        echo "üì§ Uploading test results to Zephyr Squad..."
        echo "  - Project Key: ${JIRA_PROJECT_KEY}"
        echo "  - Test Cycle: ${TEST_CYCLE_NAME}"
        
        # Upload to Zephyr Squad/Scale API (both use the same endpoint)
        RESPONSE=$(curl -w "\n%{http_code}" -s -X POST \
          "https://api.zephyrscale.smartbear.com/v2/automations/executions/junit?projectKey=${JIRA_PROJECT_KEY}&autoCreateTestCases=true" \
          -H "Authorization: Bearer ${ZEPHYR_API_TOKEN}" \
          -F "file=@combined-results.xml;type=application/xml" \
          -F "testCycle={\"name\": \"${TEST_CYCLE_NAME}\"};type=application/json")
        
        HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
        BODY=$(echo "$RESPONSE" | sed '$d')
        
        echo ""
        echo "üìã Response details:"
        echo "  - HTTP Status: $HTTP_CODE"
        echo "  - Response: $BODY"
        
        if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
          echo ""
          echo "‚úÖ Successfully uploaded test results to Zephyr Squad!"
          echo "üîó Check your test cycle: ${TEST_CYCLE_NAME}"
        else
          echo ""
          echo "‚ùå Failed to upload test results"
          echo ""
          echo "üìñ Troubleshooting steps:"
          echo "1. Verify ZEPHYR_API_TOKEN in GitHub Secrets is complete (no spaces)"
          echo "2. Check that the token hasn't expired in Zephyr Squad settings"
          echo "3. Ensure the token has access to project: ${JIRA_PROJECT_KEY}"
          echo "4. Verify your Jira project key is correct"
          echo "5. For Zephyr Squad Server (not Cloud), use different API endpoint"
          exit 1
        fi
        
    - name: Archive test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: junit-test-results
        path: |
          target/surefire-reports/
          target/site/surefire-report.html
          combined-results.xml
        retention-days: 30
        
    - name: Comment PR with test results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const testCycle = process.env.TEST_CYCLE_NAME;
          const projectKey = process.env.JIRA_PROJECT_KEY;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## üß™ Test Results Published to Zephyr Squad
            
**Test Cycle:** ${testCycle}
**Project:** ${projectKey}
**Workflow Run:** [View Details](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

Check the test results in Zephyr Squad within your Jira project.`
          });
      env:
        TEST_CYCLE_NAME: ${{ env.TEST_CYCLE_NAME }}
        JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
