name: JUnit Tests + Zephyr Scale Reporting (Container)

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  junit-zephyr:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v4

      # Step 2: Setup Java (still needed if your container doesn't have Java)
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      # Step 3: Run tests inside the container
      - name: Run Maven JUnit Tests
        run: |
          mvn -B clean test

      # Step 4: Upload test results for debugging
      - name: Persist JUnit Test Reports
        uses: actions/upload-artifact@v4
        with:
          name: junit-test-reports
          path: target/surefire-reports/*.xml

      # Step 5: Run Zephyr upload script INSIDE the container
      - name: Upload results to Zephyr Scale
        if: always()
        env:
          ZEPHYR_API_TOKEN: ${{ secrets.ZEPHYR_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
        run: |
          # Combine all test results into a single file
          find target/surefire-reports -name "TEST-*.xml" -exec cat {} \; > combined-results.xml
          
          # Upload to Zephyr Scale API
          curl -X POST \
            "https://api.zephyrscale.smartbear.com/v2/automations/executions/junit" \
            -H "Authorization: Bearer ${ZEPHYR_API_TOKEN}" \
            -H "Content-Type: multipart/form-data" \
            -F "file=@combined-results.xml" \
            -F "projectKey=${JIRA_PROJECT_KEY}" \
            -F "autoCreateTestCases=true"
            
      - name: Archive test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: |
            target/surefire-reports/
            target/site/surefire-report.html
          retention-days: 30
